{
  "hash": "1e70bc09faccbf8517bd827ee23155b8",
  "result": {
    "markdown": "---\ntitle: \"Adjusted survival curves\"\nbibliography: references.bib\n# format: pdf\n---\n\n\n\n\n:::{.callout-warning}\n\nThis page is under development. Changes should be expected. \n\n:::\n\n\n# Background\n\nUnadjusted Kaplan-Meier curves from observational data might be biased because of confounding (@COLE200445). This vignette introduces the concept of inverse probability (IP) weighted survival curves.\n\n# Example\n\nWe consider a study population of 500 patients who received a medication. 60% of the patients were women. In men, a specific enzyme was measured with a probability of 30%, whereas in women have a 5 times higher chance of having the enzyme. Those with the enzyme were more likely to receive the medication (with a probability of 75%), compared to those without the enzyme (probability of 50%).\n\n- Research question: What is the effect of the medication on death?\n- Study design: Cohort study\n- Outcome of interest: Time to death or end of follow-up\n- Predictor of interest: Medication\n- Confounders: Sex, enzyme\n\nThe used variables from the data are:\n\n| Variable | Definition | Coding |\n| --- | --- | --- |\n| female | Sex | 1=Women, 0=Men |\n| enzyme | Measured enzyme | 1=Present, 0=Not present |\n| medi | Medication | 1=Received, 0=Not received |\n| death | Death | 1=Death, 0=Alive |\n| fup | Follow-up time | Non-negative number |\n\n## Knowledge from the crystal ball\n\nBecause we simulated the data, we know that medication has no effect on mortality.\n\n# Analysis strategy\n\nIP weighting constructs weights which are equal to the probability of an individual's treatment (here: receiving the medication) given observed covariates (here: sex and enzyme) and creates pseudopopulations in which observed covariates are independent of treatment (i.e. no confounding) (@hernan_book).\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Required packages\nlibrary(tidyverse)\nlibrary(survey)\nlibrary(survival)\nlibrary(gtsummary)\nlibrary(survminer)\n```\n:::\n\n\n\n\n## Descriptive table\n\nThe table below shows a descriptive summary of the study population, by medication.\n\n\n\n```{.r .cell-code}\ndata %>% \n  tbl_summary(by = medi) \n```\n\n::: {.cell-output-display}\n```{=html}\n<div id=\"jgintxqbum\" style=\"overflow-x:auto;overflow-y:auto;width:auto;height:auto;\">\n<style>html {\n  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;\n}\n\n#jgintxqbum .gt_table {\n  display: table;\n  border-collapse: collapse;\n  margin-left: auto;\n  margin-right: auto;\n  color: #333333;\n  font-size: 16px;\n  font-weight: normal;\n  font-style: normal;\n  background-color: #FFFFFF;\n  width: auto;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #A8A8A8;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #A8A8A8;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n}\n\n#jgintxqbum .gt_heading {\n  background-color: #FFFFFF;\n  text-align: center;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#jgintxqbum .gt_title {\n  color: #333333;\n  font-size: 125%;\n  font-weight: initial;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-color: #FFFFFF;\n  border-bottom-width: 0;\n}\n\n#jgintxqbum .gt_subtitle {\n  color: #333333;\n  font-size: 85%;\n  font-weight: initial;\n  padding-top: 0;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-color: #FFFFFF;\n  border-top-width: 0;\n}\n\n#jgintxqbum .gt_bottom_border {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#jgintxqbum .gt_col_headings {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#jgintxqbum .gt_col_heading {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  overflow-x: hidden;\n}\n\n#jgintxqbum .gt_column_spanner_outer {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  padding-top: 0;\n  padding-bottom: 0;\n  padding-left: 4px;\n  padding-right: 4px;\n}\n\n#jgintxqbum .gt_column_spanner_outer:first-child {\n  padding-left: 0;\n}\n\n#jgintxqbum .gt_column_spanner_outer:last-child {\n  padding-right: 0;\n}\n\n#jgintxqbum .gt_column_spanner {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 5px;\n  overflow-x: hidden;\n  display: inline-block;\n  width: 100%;\n}\n\n#jgintxqbum .gt_group_heading {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#jgintxqbum .gt_empty_group_heading {\n  padding: 0.5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#jgintxqbum .gt_from_md > :first-child {\n  margin-top: 0;\n}\n\n#jgintxqbum .gt_from_md > :last-child {\n  margin-bottom: 0;\n}\n\n#jgintxqbum .gt_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  margin: 10px;\n  border-top-style: solid;\n  border-top-width: 1px;\n  border-top-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  overflow-x: hidden;\n}\n\n#jgintxqbum .gt_stub {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#jgintxqbum .gt_stub_row_group {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n  vertical-align: top;\n}\n\n#jgintxqbum .gt_row_group_first td {\n  border-top-width: 2px;\n}\n\n#jgintxqbum .gt_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#jgintxqbum .gt_first_summary_row {\n  border-top-style: solid;\n  border-top-color: #D3D3D3;\n}\n\n#jgintxqbum .gt_first_summary_row.thick {\n  border-top-width: 2px;\n}\n\n#jgintxqbum .gt_last_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#jgintxqbum .gt_grand_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#jgintxqbum .gt_first_grand_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: double;\n  border-top-width: 6px;\n  border-top-color: #D3D3D3;\n}\n\n#jgintxqbum .gt_striped {\n  background-color: rgba(128, 128, 128, 0.05);\n}\n\n#jgintxqbum .gt_table_body {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#jgintxqbum .gt_footnotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#jgintxqbum .gt_footnote {\n  margin: 0px;\n  font-size: 90%;\n  padding-left: 4px;\n  padding-right: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#jgintxqbum .gt_sourcenotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#jgintxqbum .gt_sourcenote {\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#jgintxqbum .gt_left {\n  text-align: left;\n}\n\n#jgintxqbum .gt_center {\n  text-align: center;\n}\n\n#jgintxqbum .gt_right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n#jgintxqbum .gt_font_normal {\n  font-weight: normal;\n}\n\n#jgintxqbum .gt_font_bold {\n  font-weight: bold;\n}\n\n#jgintxqbum .gt_font_italic {\n  font-style: italic;\n}\n\n#jgintxqbum .gt_super {\n  font-size: 65%;\n}\n\n#jgintxqbum .gt_footnote_marks {\n  font-style: italic;\n  font-weight: normal;\n  font-size: 75%;\n  vertical-align: 0.4em;\n}\n\n#jgintxqbum .gt_asterisk {\n  font-size: 100%;\n  vertical-align: 0;\n}\n\n#jgintxqbum .gt_indent_1 {\n  text-indent: 5px;\n}\n\n#jgintxqbum .gt_indent_2 {\n  text-indent: 10px;\n}\n\n#jgintxqbum .gt_indent_3 {\n  text-indent: 15px;\n}\n\n#jgintxqbum .gt_indent_4 {\n  text-indent: 20px;\n}\n\n#jgintxqbum .gt_indent_5 {\n  text-indent: 25px;\n}\n</style>\n<table class=\"gt_table\">\n  \n  <thead class=\"gt_col_headings\">\n    <tr>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_left\" rowspan=\"1\" colspan=\"1\" scope=\"col\"><strong>Characteristic</strong></th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" scope=\"col\"><strong>0</strong>, N = 172<sup class=\"gt_footnote_marks\">1</sup></th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" scope=\"col\"><strong>1</strong>, N = 328<sup class=\"gt_footnote_marks\">1</sup></th>\n    </tr>\n  </thead>\n  <tbody class=\"gt_table_body\">\n    <tr><td class=\"gt_row gt_left\">fup</td>\n<td class=\"gt_row gt_center\">8 (3, 17)</td>\n<td class=\"gt_row gt_center\">6 (3, 14)</td></tr>\n    <tr><td class=\"gt_row gt_left\">death</td>\n<td class=\"gt_row gt_center\">65 (38%)</td>\n<td class=\"gt_row gt_center\">156 (48%)</td></tr>\n    <tr><td class=\"gt_row gt_left\">enzyme</td>\n<td class=\"gt_row gt_center\">64 (37%)</td>\n<td class=\"gt_row gt_center\">199 (61%)</td></tr>\n    <tr><td class=\"gt_row gt_left\">female</td>\n<td class=\"gt_row gt_center\">102 (59%)</td>\n<td class=\"gt_row gt_center\">210 (64%)</td></tr>\n  </tbody>\n  \n  <tfoot class=\"gt_footnotes\">\n    <tr>\n      <td class=\"gt_footnote\" colspan=\"3\"><sup class=\"gt_footnote_marks\">1</sup> Median (IQR); n (%)</td>\n    </tr>\n  </tfoot>\n</table>\n</div>\n```\n:::\n\n\n## Unadjusted Kaplan-Meier curve and Cox-modelling\n\nA naive (unadjusted) survival analysis of the data reveals the following Kaplan-Meier plot. We conclude that the medication has an effect on survival.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmod <- survfit(Surv(fup, death) ~ medi, data = data)\nggsurvplot(mod, data = data, palette = c(\"#CC0000\", \"black\"), censor = FALSE)\n```\n\n::: {.cell-output-display}\n![](AdjustedSurvivalCurves_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmod_cox_unadjusted <- coxph(Surv(fup, death) ~ medi, data = data)\nmod_cox_unadjusted\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nCall:\ncoxph(formula = Surv(fup, death) ~ medi, data = data)\n\n       coef exp(coef) se(coef)     z      p\nmedi 0.3345    1.3973   0.1479 2.262 0.0237\n\nLikelihood ratio test=5.34  on 1 df, p=0.0209\nn= 500, number of events= 221 \n```\n:::\n:::\n\n\nAn unadjusted Cox proportional hazard model shows that patients with medication have 1.4 higher hazard of death compared to those without medication.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmod_cox_adjusted <- coxph(Surv(fup, death) ~ medi + enzyme + female, data = data)\nmod_cox_adjusted\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nCall:\ncoxph(formula = Surv(fup, death) ~ medi + enzyme + female, data = data)\n\n           coef exp(coef) se(coef)      z      p\nmedi    0.01920   1.01938  0.14993  0.128  0.898\nenzyme  2.12737   8.39280  0.20308 10.475 <2e-16\nfemale -0.03787   0.96284  0.16500 -0.230  0.818\n\nLikelihood ratio test=179.2  on 3 df, p=< 2.2e-16\nn= 500, number of events= 221 \n```\n:::\n:::\n\n\nWhat happens if we adjust for enzym and sex? Then the effect of the medication on death vanishes (hazard ratio=1.02).\n\n## IPW modelling\n\nAn IPW modelling approach constructs treatment weights (here medication) given known covariates (here sex and enzyme) using a logistic regression model.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# IPW denominator\nmod <- glm(medi ~ female + enzyme, data = data, family = binomial())\n\ndata$ipw <- NA\n# Probabilty of treatment\ndata$ipw <- predict(mod, data = data, type = \"response\")\n# Probabilty of non-treatment\ndata$ipw[data$medi==0] <- 1 - predict(mod, data = data, type = \"response\")[data$medi == 0]\n```\n:::\n\n\nWe construct stabilized weights, since they can provide narrower confidence intervals (@hernan_book).\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Stabilized weights\nmod0 <- glm(medi ~ 1, data = data, family = binomial())\ndata$ipw0 <- predict(mod0, data = data, type = \"response\")\ndata$ipw0[data$medi == 0] <- 1 - predict(mod0, data = data, type = \"response\")[data$medi == 0]\ndata$ipw <- data$ipw0 / data$ipw\n```\n:::\n\n\nAn IPW adjusted Kaplan-Meier curve reveals that medication has no effect on survival:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Set survey design\nsvy_design <- svydesign(id = ~1, weights = ~ipw, data = data)\n\n# IPW adjusted Kaplan-Meier\nkm_fit <- svykm(Surv(fup, death) ~ medi, design = svy_design)\n\nkm_df <- data.frame(time = km_fit$`1`$time, surv = km_fit$`1`$surv, strata = \"medi=1\")\nkm_df <- bind_rows(km_df, data.frame(time=km_fit$`0`$time, surv=km_fit$`0`$surv, strata = \"medi=0\"))\nggsurvplot_df(km_df, palette = c(\"#CC0000\", \"black\"), censor=FALSE)\n```\n\n::: {.cell-output-display}\n![](AdjustedSurvivalCurves_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmod_cox_ipw_adjusted <- svycoxph(Surv(fup, death) ~ medi, design = svy_design)\nsummary(mod_cox_ipw_adjusted)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nIndependent Sampling design (with replacement)\nsvydesign(id = ~1, weights = ~ipw, data = data)\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\nCall:\nsvycoxph(formula = Surv(fup, death) ~ medi, design = svy_design)\n\n  n= 500, number of events= 221 \n\n         coef exp(coef) se(coef) robust se      z Pr(>|z|)\nmedi -0.04057   0.96024  0.14165   0.14255 -0.285    0.776\n\n     exp(coef) exp(-coef) lower .95 upper .95\nmedi    0.9602      1.041    0.7262      1.27\n\nConcordance= 0.494  (se = 0.019 )\nLikelihood ratio test= NA  on 1 df,   p=NA\nWald test            = 0.08  on 1 df,   p=0.8\nScore (logrank) test = NA  on 1 df,   p=NA\n\n  (Note: the likelihood ratio and score tests assume independence of\n     observations within a cluster, the Wald and robust score tests do not).\n```\n:::\n:::\n\n\nThis is confirmed by an IPW adjusted Cox regression model (hazard ratio=0.96).\n\n# Conclusion\n\nUnadjusted Kaplan-Meier curves from observational data might be biased because of confounding. IPW adjusted survival curves account for confounding by constructing weights which are proportional to the probability of treatment given known covariates. An advantage of IPW adjusted Kaplan-Meier curves is that they provide marginal survival estimates, in contrast to stratified plots (@COLE200445).\n\n# Data simulation\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(1)\nn <- 500\n\n# 60% percent women\nfemale <- rbinom(n, 1, 0.6)\n# Men has the enzyme with a prob of 0.3; women have\n# a 5 times higher chance of having the enzym\nenzyme <- ifelse(runif(n) < plogis(qlogis(0.3) + log(5) * female), 1, 0)\n# Those with enzyme receive medication with prob 0.75\nmedi <- ifelse(runif(n) < plogis(log(3) * enzyme), 1, 0)\n# Hazard of dying: HR=10 of those with enzyme; No effect for medication\nhaz <- 0.01 * exp(log(10) * enzyme)\n# Time to death\ntime_to_death <- -log(runif(n)) / haz\n# Censoring time: Mean duration 20 days\ncensored <- rweibull(n, 1, 20)\n# Follow-up time\nfup <- pmin(time_to_death, censored)\n# Death\ndeath <- ifelse(time_to_death <= censored, 1, 0)\n# Data\ndata <- data.frame(fup, death, medi, enzyme, female)\n```\n:::\n\n\n# References\n",
    "supporting": [
      "AdjustedSurvivalCurves_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}